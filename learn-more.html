<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Under the Hood - WireClaw</title>
<<<<<<< HEAD
  <meta name="description" content="How a $5 ESP32-C6 chip becomes an autonomous AI agent. Architecture, tools, LED feedback, and technical specs.">
=======
  <meta name="description" content="How a $5 ESP32-C6 chip runs 17 tools, a rule engine, and an AI agent. Architecture, tools, LED feedback, and technical specs.">
>>>>>>> add/rule-evaluation-loop
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/landing.css">
  <link rel="stylesheet" href="css/learn-more.css">
  <link rel="stylesheet" href="css/animations.css">
  <link rel="stylesheet" href="css/responsive.css">
</head>
<body>

  <!-- Navigation -->
  <header class="site-header">
    <div class="container">
      <a href="/" class="logo" aria-label="WireClaw home">
        <img src="assets/logo.svg" width="32" height="32" alt="" aria-hidden="true">
        <span>WireClaw</span>
      </a>
      <nav class="nav-links" aria-label="Main navigation">
        <a href="learn-more.html">Learn More</a>
        <a href="architecture.html">Architecture</a>
        <a href="https://github.com/M64GitHub/WireClaw" target="_blank" rel="noopener" class="btn btn-outline btn-sm">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
          GitHub
        </a>
      </nav>
      <button class="hamburger" aria-label="Toggle menu" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </header>

  <!-- Page Hero -->
  <section class="page-hero">
    <div class="container">
      <h1 class="reveal">Under the <span class="accent">Hood</span></h1>
      <p class="reveal" style="--stagger: 1">How a $5 chip runs 17 tools, a rule engine, and an AI agent.</p>
    </div>
  </section>

  <!-- Architecture Deep Dive -->
  <section class="architecture-deep">
    <div class="container">
      <div class="section-header reveal">
<<<<<<< HEAD
        <h2>The Agentic <span class="accent">Architecture</span></h2>
        <p>From user message to real-world action - every step on a single chip.</p>
=======
        <h2>Dual-Loop <span class="accent">Architecture</span></h2>
        <p>Two systems on one chip. The AI creates. The rules execute.</p>
>>>>>>> add/rule-evaluation-loop
      </div>
      <div class="arch-steps">
        <div class="arch-step reveal" style="--stagger: 0">
          <div class="arch-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
          </div>
          <div>
<<<<<<< HEAD
            <h3>Input Channels</h3>
            <p>Telegram bot, USB serial console, or NATS messaging - all three feed into the same processing pipeline. The agent doesn't care how you talk to it.</p>
=======
            <h3>Two Loops, One Chip</h3>
            <p>The main <code>loop()</code> runs two systems. The Rule Loop evaluates automation rules every iteration - no network, no latency. The AI Loop activates only when a message arrives via Telegram, serial, or NATS.</p>
>>>>>>> add/rule-evaluation-loop
          </div>
        </div>
        <div class="arch-step reveal" style="--stagger: 1">
          <div class="arch-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          </div>
          <div>
            <h3>Rule Engine</h3>
            <p>Persistent automation. Reads sensors, checks conditions (<code>gt</code>, <code>lt</code>, <code>eq</code>, <code>neq</code>, <code>change</code>, <code>always</code>), fires actions (actuator, LED, GPIO, NATS, Telegram). Edge-triggered - fires once per transition, auto-resets. Survives reboots.</p>
          </div>
        </div>
        <div class="arch-step reveal" style="--stagger: 2">
          <div class="arch-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M12 2a7 7 0 017 7c0 5-7 11-7 11S5 14 5 9a7 7 0 017-7z"/><circle cx="12" cy="9" r="2.5"/></svg>
          </div>
          <div>
<<<<<<< HEAD
            <h3>LLM Integration</h3>
            <p>Direct HTTPS calls to OpenRouter (or any OpenAI-compatible endpoint). Model is runtime-configurable via flash config. No proxy, no middleware - the ESP32 talks to the API directly.</p>
=======
            <h3>AI Loop</h3>
            <p>LLM via OpenRouter. 17 tools. Up to 5 iterations per request. Creates rules, registers devices, reads sensors, writes files. The AI is the compiler - it turns intent into persistent automation.</p>
>>>>>>> add/rule-evaluation-loop
          </div>
        </div>
        <div class="arch-step reveal" style="--stagger: 3">
          <div class="arch-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M8 7h8M8 11h5M8 15h8"/></svg>
          </div>
          <div>
<<<<<<< HEAD
            <h3>Tool Execution</h3>
            <p>Seven built-in tools give the agent direct hardware control - LEDs, GPIO, sensors, filesystem, and device-to-device messaging via NATS.</p>
=======
            <h3>Device Registry</h3>
            <p>Named sensors and actuators persisted to flash. Register once, reference by name everywhere. <code>chip_temp</code> is pre-registered on first boot. Five sensor types, three actuator types.</p>
>>>>>>> add/rule-evaluation-loop
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 17 Tools -->
  <section class="tools-section">
    <div class="container">
      <div class="section-header reveal">
        <h2>17 <span class="accent">Tools</span></h2>
        <p>Each tool maps to a real hardware or system capability.</p>
      </div>
<<<<<<< HEAD
      <div class="tools-grid">
        <div class="tool-card reveal" style="--stagger: 0">
          <div class="tool-name">led_set</div>
          <span class="tool-badge">LED</span>
          <p>Control the onboard RGB LED - set any color, brightness, or turn it off. Visual feedback for every action.</p>
=======
      <div class="tools-summary reveal">
        <div class="tools-summary-row">
          <span class="tools-summary-label">Hardware (4)</span>
          <span class="tools-summary-list"><code>led_set</code>, <code>gpio_write</code>, <code>gpio_read</code>, <code>temperature_read</code></span>
>>>>>>> add/rule-evaluation-loop
        </div>
        <div class="tools-summary-row">
          <span class="tools-summary-label">Device Registry (5)</span>
          <span class="tools-summary-list"><code>device_register</code>, <code>device_list</code>, <code>device_remove</code>, <code>sensor_read</code>, <code>actuator_set</code></span>
        </div>
        <div class="tools-summary-row">
          <span class="tools-summary-label">Rule Engine (4)</span>
          <span class="tools-summary-list"><code>rule_create</code>, <code>rule_list</code>, <code>rule_delete</code>, <code>rule_enable</code></span>
        </div>
<<<<<<< HEAD
        <div class="tool-card reveal" style="--stagger: 3">
          <div class="tool-name">device_info</div>
          <span class="tool-badge">System</span>
          <p>Query free heap, uptime, WiFi signal strength, chip temperature, and more.</p>
        </div>
        <div class="tool-card reveal" style="--stagger: 4">
          <div class="tool-name">file_read</div>
          <span class="tool-badge">Flash FS</span>
          <p>Read files from the onboard flash filesystem - configs, logs, persisted data.</p>
        </div>
        <div class="tool-card reveal" style="--stagger: 5">
          <div class="tool-name">file_write</div>
          <span class="tool-badge">Flash FS</span>
          <p>Write data to flash - persist sensor readings, update configuration, save notes.</p>
        </div>
        <div class="tool-card reveal" style="--stagger: 6">
          <div class="tool-name">nats_publish</div>
          <span class="tool-badge">Messaging</span>
          <p>Publish messages to NATS subjects for device-to-device communication and IoT mesh coordination.</p>
=======
        <div class="tools-summary-row">
          <span class="tools-summary-label">System (4)</span>
          <span class="tools-summary-list"><code>device_info</code>, <code>file_read</code>, <code>file_write</code>, <code>nats_publish</code></span>
>>>>>>> add/rule-evaluation-loop
        </div>
      </div>
      <div style="text-align: center; margin-top: var(--space-xl);">
        <a href="architecture.html#tools" class="arch-link reveal" style="--stagger: 1">Full tool reference →</a>
      </div>
    </div>
  </section>

  <!-- LED Feedback -->
  <section class="led-section">
    <div class="container">
      <div class="section-header reveal">
        <h2>LED <span class="accent">Feedback</span> System</h2>
        <p>The onboard LED tells you what the agent is doing at a glance.</p>
      </div>
      <div class="led-row">
        <div class="led-item">
          <div class="led-circle led-orange" style="--stagger: 0"></div>
          <span class="led-label">Connecting</span>
        </div>
        <div class="led-item">
          <div class="led-circle led-blue" style="--stagger: 1"></div>
          <span class="led-label">Thinking</span>
        </div>
        <div class="led-item">
          <div class="led-circle led-purple" style="--stagger: 2"></div>
          <span class="led-label">Tool Loop</span>
        </div>
        <div class="led-item">
          <div class="led-circle led-green" style="--stagger: 3"></div>
          <span class="led-label">Success</span>
        </div>
        <div class="led-item">
          <div class="led-circle led-red" style="--stagger: 4"></div>
          <span class="led-label">Error</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Conversation Persistence -->
  <section class="persistence-section">
    <div class="container">
      <div class="section-header reveal">
        <h2>Memory That <span class="accent">Survives</span> Reboots</h2>
        <p>A 6-turn circular buffer stored on flash. Context persists across power cycles.</p>
      </div>
      <div class="ring-buffer reveal">
        <div class="buffer-slot filled" style="--stagger: 0">U:1</div>
        <div class="buffer-slot filled" style="--stagger: 1">A:1</div>
        <div class="buffer-slot filled" style="--stagger: 2">U:2</div>
        <div class="buffer-slot filled" style="--stagger: 3">A:2</div>
        <div class="buffer-slot filled" style="--stagger: 4">U:3</div>
        <div class="buffer-slot write-head" style="--stagger: 5">A:3</div>
      </div>
      <p class="ring-label reveal" style="--stagger: 6">← oldest ··· newest →  (write head)</p>
    </div>
  </section>

  <!-- Technical Specs -->
  <section class="specs-section">
    <div class="container">
      <div class="section-header reveal">
        <h2>Technical <span class="accent">Specs</span></h2>
      </div>
      <div class="specs-wrapper reveal">
        <table class="specs-table">
          <tbody>
            <tr><th>MCU</th><td>ESP32-C6 (RISC-V, 160 MHz, 512 KB SRAM)</td></tr>
            <tr><th>Framework</th><td>Arduino + PlatformIO</td></tr>
            <tr><th>Language</th><td>C++ (Arduino-flavored)</td></tr>
            <tr><th>RAM Usage</th><td>~280 KB with active conversation</td></tr>
            <tr><th>Tools</th><td>17 built-in (hardware, registry, rules, filesystem, messaging)</td></tr>
            <tr><th>Rule Engine</th><td>6 conditions, 5 action types, edge-triggered, /rules.json</td></tr>
            <tr><th>Device Registry</th><td>5 sensor types, 3 actuator types, persisted to flash</td></tr>
            <tr><th>Telegram Alerts</th><td>Rule-triggered, no LLM, configurable cooldown</td></tr>
            <tr><th>JSON Parsing</th><td>Streaming token-by-token (ArduinoJson)</td></tr>
            <tr><th>Buffer Strategy</th><td>Chunked HTTP reads, reused scratch buffers</td></tr>
            <tr><th>Flash Storage</th><td>LittleFS partition for config, history, rules, and device registry</td></tr>
            <tr><th>API Protocol</th><td>HTTPS with TLS 1.2, OpenAI-compatible chat completions</td></tr>
            <tr><th>NATS Support</th><td>Lightweight publish over TCP</td></tr>
            <tr><th>Configuration</th><td>JSON config on flash - WiFi, API key, model, system prompt</td></tr>
            <tr><th>History Buffer</th><td>6-turn circular buffer persisted to flash</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Getting Started -->
  <section class="getting-started">
    <div class="container">
      <div class="section-header reveal">
        <h2>Getting <span class="accent">Started</span></h2>
        <p>Three steps from zero to a working AI agent.</p>
      </div>
      <div class="steps-list">
        <div class="step-card reveal" style="--stagger: 0">
          <div class="step-number">1</div>
          <div>
            <h3>Flash the Firmware</h3>
            <p>Clone the repo and upload with PlatformIO: <code>pio run -t upload</code></p>
          </div>
        </div>
        <div class="step-card reveal" style="--stagger: 1">
          <div class="step-number">2</div>
          <div>
            <h3>Configure on Flash</h3>
            <p>Edit <code>system_prompt.txt</code> and <code>config.json</code> with your WiFi credentials, API key, and model. Upload with <code>pio run -t uploadfs</code></p>
          </div>
        </div>
        <div class="step-card reveal" style="--stagger: 2">
          <div class="step-number">3</div>
          <div>
            <h3>Talk to It</h3>
            <p>Send natural language via Telegram, serial console, or NATS - the agent handles the rest.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GitHub CTA -->
  <section class="github-cta">
    <div class="container">
      <h2 class="reveal">Ready to Put AI on the <span class="accent">Wire</span>?</h2>
      <div class="hero-ctas" style="justify-content: center;">
        <a href="https://github.com/M64GitHub/WireClaw" target="_blank" rel="noopener" class="btn btn-primary reveal" style="--stagger: 1">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
          View on GitHub
        </a>
        <a href="architecture.html" class="btn btn-outline reveal" style="--stagger: 2">Dive Deeper →</a>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-logo">
        <img src="assets/logo.svg" width="28" height="28" alt="" aria-hidden="true">
        <span>WireClaw</span>
      </div>
      <nav class="footer-links" aria-label="Footer navigation">
        <a href="/">Home</a>
        <a href="architecture.html">Architecture</a>
        <a href="https://github.com/M64GitHub/WireClaw" target="_blank" rel="noopener">GitHub</a>
      </nav>
      <span class="footer-copy">&copy; 2026 M64</span>
    </div>
  </footer>

  <script defer src="js/nav.js"></script>
  <script defer src="js/scroll-reveal.js"></script>
</body>
</html>
