<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Under the Hood - WireClaw</title>
  <meta name="description" content="How a $5 ESP32-C6 chip runs 18 tools, a rule engine, and an AI agent. Architecture, tools, LED feedback, and technical specs.">
  <meta name="author" content="Mario Schallner">
  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://wireclaw.io/learn-more.html">
  <meta property="og:title" content="Under the Hood — WireClaw">
  <meta property="og:description" content="How a $5 ESP32-C6 chip runs 18 tools, a rule engine, NATS mesh, and an AI agent. Architecture, tools, and technical specs.">
  <meta property="og:image" content="https://wireclaw.io/assets/preview.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="WireClaw">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Under the Hood — WireClaw">
  <meta name="twitter:description" content="How a $5 ESP32-C6 chip runs 18 tools, a rule engine, and an AI agent.">
  <meta name="twitter:image" content="https://wireclaw.io/assets/preview.png">
  <!-- Theme -->
  <meta name="theme-color" content="#00d4aa">
  <link rel="canonical" href="https://wireclaw.io/learn-more.html">
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/landing.css">
  <link rel="stylesheet" href="css/learn-more.css">
  <link rel="stylesheet" href="css/animations.css">
  <link rel="stylesheet" href="css/responsive.css">
</head>
<body>

  <!-- Navigation -->
  <header class="site-header">
    <div class="container">
      <a href="/" class="logo" aria-label="WireClaw home">
        <img src="assets/logo.svg" width="32" height="32" alt="" aria-hidden="true">
        <span>WireClaw</span>
      </a>
      <nav class="nav-links" aria-label="Main navigation">
        <a href="learn-more.html">Learn More</a>
        <a href="architecture.html">Architecture</a>
        <a href="https://github.com/M64GitHub/WireClaw" target="_blank" rel="noopener" class="btn btn-outline btn-sm">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
          GitHub
        </a>
        <a href="flash.html" class="btn btn-primary btn-sm">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          Flash Now
        </a>
      </nav>
      <button class="hamburger" aria-label="Toggle menu" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </header>

  <!-- Page Hero -->
  <section class="page-hero">
    <div class="container">
      <h1 class="reveal">Under the <span class="accent">Hood</span></h1>
      <p class="reveal" style="--stagger: 1">How a $5 chip runs 18 tools, a rule engine, and an AI agent. Cloud optional.</p>
    </div>
  </section>

  <!-- Architecture Deep Dive -->
  <section class="architecture-deep">
    <div class="container">
      <div class="section-header reveal">
        <h2>Dual-Loop <span class="accent">Architecture</span></h2>
        <p>Two systems on one chip. The AI creates. The rules execute.</p>
      </div>
      <div class="arch-steps">
        <div class="arch-step reveal" style="--stagger: 0">
          <div class="arch-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
          </div>
          <div>
            <h3>Two Loops, One Chip</h3>
            <p>The main <code>loop()</code> runs two systems. The Rule Loop evaluates automation rules every iteration - no network, no latency. The AI Loop activates only when a message arrives via Telegram, serial, or NATS.</p>
          </div>
        </div>
        <div class="arch-step reveal" style="--stagger: 1">
          <div class="arch-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          </div>
          <div>
            <h3>Rule Engine</h3>
            <p>Persistent automation. Reads sensors, checks conditions (<code>gt</code>, <code>lt</code>, <code>eq</code>, <code>neq</code>, <code>change</code>, <code>always</code>), fires actions (actuator, LED, GPIO, NATS, Telegram). Edge-triggered conditions fire once per transition, then auto-reset. The <code>always</code> condition fires every <code>interval_seconds</code> - use it for periodic reports and heartbeats. Message interpolation: <code>{value}</code>, <code>{device_name}</code>, <code>{name:msg}</code>. Survives reboots.</p>
          </div>
        </div>
        <div class="arch-step reveal" style="--stagger: 2">
          <div class="arch-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M12 2a7 7 0 017 7c0 5-7 11-7 11S5 14 5 9a7 7 0 017-7z"/><circle cx="12" cy="9" r="2.5"/></svg>
          </div>
          <div>
            <h3>AI Loop</h3>
            <p>LLM via OpenRouter, Ollama, llama.cpp, or any OpenAI-compatible endpoint. HTTPS for cloud, HTTP for local (saves ~40% RAM). 18 tools. Up to 5 iterations per request. Creates rules, registers devices, reads sensors, writes files. The AI is the compiler - it turns intent into persistent automation.</p>
          </div>
        </div>
        <div class="arch-step reveal" style="--stagger: 3">
          <div class="arch-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M8 7h8M8 11h5M8 15h8"/></svg>
          </div>
          <div>
            <h3>Device Registry</h3>
            <p>Named sensors and actuators persisted to flash. Register once, reference by name everywhere. <code>chip_temp</code> is pre-registered on first boot. Eight sensor types, three actuator types. Clock sensors auto-register on boot.</p>
          </div>
        </div>
        <div class="arch-step reveal" style="--stagger: 4">
          <div class="arch-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          </div>
          <div>
            <h3>Time-Based Automation</h3>
            <p>Virtual clock sensors (<code>clock_hour</code>, <code>clock_minute</code>, <code>clock_hhmm</code>) auto-register on boot. NTP-synced with timezone and DST. Schedule anything - the same rule engine that watches temperature can watch the clock.</p>
          </div>
        </div>
        <div class="arch-step reveal" style="--stagger: 5">
          <div class="arch-step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="5" cy="12" r="3"/><circle cx="19" cy="5" r="3"/><circle cx="19" cy="19" r="3"/><path d="M8 12h4M15.5 7l-3.5 3M15.5 17l-3.5-3"/></svg>
          </div>
          <div>
            <h3>NATS Mesh Communication</h3>
            <p>Devices talk to each other over NATS. Register <code>nats_value</code> sensors that subscribe to external subjects and feed data into the rule engine. The <code>remote_chat</code> tool lets one device's AI ask another a natural language question. Publish sensor data, trigger cross-device rules, build a mesh of $5 autonomous agents.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 18 Tools -->
  <section class="tools-section">
    <div class="container">
      <div class="section-header reveal">
        <h2>18 <span class="accent">Tools</span></h2>
        <p>Each tool maps to a real hardware or system capability.</p>
      </div>
      <div class="tools-summary reveal">
        <div class="tools-summary-row">
          <span class="tools-summary-label">Hardware (4)</span>
          <span class="tools-summary-list"><code>led_set</code>, <code>gpio_write</code>, <code>gpio_read</code>, <code>temperature_read</code></span>
        </div>
        <div class="tools-summary-row">
          <span class="tools-summary-label">Device Registry (5)</span>
          <span class="tools-summary-list"><code>device_register</code>, <code>device_list</code>, <code>device_remove</code>, <code>sensor_read</code>, <code>actuator_set</code></span>
        </div>
        <div class="tools-summary-row">
          <span class="tools-summary-label">Rule Engine (4)</span>
          <span class="tools-summary-list"><code>rule_create</code>, <code>rule_list</code>, <code>rule_delete</code>, <code>rule_enable</code></span>
        </div>
        <div class="tools-summary-row">
          <span class="tools-summary-label">System (3)</span>
          <span class="tools-summary-list"><code>device_info</code>, <code>file_read</code>, <code>file_write</code></span>
        </div>
        <div class="tools-summary-row">
          <span class="tools-summary-label">Messaging (2)</span>
          <span class="tools-summary-list"><code>nats_publish</code>, <code>remote_chat</code></span>
        </div>
      </div>
      <div style="text-align: center; margin-top: var(--space-xl);">
        <a href="architecture.html#tools" class="arch-link reveal" style="--stagger: 1">Full tool reference →</a>
      </div>
    </div>
  </section>

  <!-- LED Feedback -->
  <section class="led-section">
    <div class="container">
      <div class="section-header reveal">
        <h2>LED <span class="accent">Feedback</span> System</h2>
        <p>The onboard LED tells you what the agent is doing at a glance.</p>
      </div>
      <div class="led-row">
        <div class="led-item">
          <div class="led-circle led-orange" style="--stagger: 0"></div>
          <span class="led-label">Connecting</span>
        </div>
        <div class="led-item">
          <div class="led-circle led-blue" style="--stagger: 1"></div>
          <span class="led-label">Thinking</span>
        </div>
        <div class="led-item">
          <div class="led-circle led-purple" style="--stagger: 2"></div>
          <span class="led-label">Tool Loop</span>
        </div>
        <div class="led-item">
          <div class="led-circle led-green" style="--stagger: 3"></div>
          <span class="led-label">Success</span>
        </div>
        <div class="led-item">
          <div class="led-circle led-red" style="--stagger: 4"></div>
          <span class="led-label">Error</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Conversation Persistence -->
  <section class="persistence-section">
    <div class="container">
      <div class="section-header reveal">
        <h2>Memory That <span class="accent">Survives</span> Reboots</h2>
      </div>

      <h3 class="reveal" style="text-align: center; margin-bottom: var(--space-lg);">Conversation Buffer</h3>
      <p class="reveal" style="text-align: center; max-width: 550px; margin: 0 auto var(--space-xl);">A 6-turn circular buffer stored on flash. Context persists across power cycles.</p>
      <div class="ring-buffer reveal">
        <div class="buffer-slot filled" style="--stagger: 0">U:1</div>
        <div class="buffer-slot filled" style="--stagger: 1">A:1</div>
        <div class="buffer-slot filled" style="--stagger: 2">U:2</div>
        <div class="buffer-slot filled" style="--stagger: 3">A:2</div>
        <div class="buffer-slot filled" style="--stagger: 4">U:3</div>
        <div class="buffer-slot write-head" style="--stagger: 5">A:3</div>
      </div>
      <p class="ring-label reveal" style="--stagger: 6">← oldest ··· newest →  (write head)</p>

      <h3 class="reveal" style="text-align: center; margin-top: var(--space-3xl); margin-bottom: var(--space-lg);">Persistent Memory</h3>
      <p class="reveal" style="text-align: center; max-width: 550px; margin: 0 auto var(--space-xl);">Long-term preferences in <code>/memory.txt</code> on flash. The AI writes autonomously. Injected into every conversation. 512 chars. Survives reboots.</p>
      <div class="reveal" style="max-width: 440px; margin: 0 auto var(--space-xl); font-family: var(--font-mono); font-size: 0.8rem; line-height: 1.8; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: var(--space-md) var(--space-lg);">
        <div><span style="color: var(--accent);">></span> <span style="color: var(--text-primary);">"My favorite color is blue"</span></div>
        <div style="color: var(--text-muted);">  [writes to /memory.txt]</div>
        <div style="color: var(--led-blue);">  --- reboot ---</div>
        <div><span style="color: var(--accent);">></span> <span style="color: var(--text-primary);">"Set the LED to my favorite color"</span></div>
        <div style="color: var(--led-green);">  LED set to blue (0, 0, 255)</div>
      </div>
      <div class="memory-file reveal">
        <div class="memory-file-header">/memory.txt</div>
        <div class="memory-file-body">User's favorite color is blue.
Prefers Celsius for temperature.
Garden-node is the outdoor sensor.</div>
      </div>
    </div>
  </section>

  <!-- Technical Specs -->
  <section class="specs-section">
    <div class="container">
      <div class="section-header reveal">
        <h2>Technical <span class="accent">Specs</span></h2>
      </div>
      <div class="specs-wrapper reveal">
        <table class="specs-table">
          <tbody>
            <tr><th>MCU</th><td>ESP32-C6 (RISC-V, 160 MHz, 512 KB SRAM)</td></tr>
            <tr><th>Framework</th><td>Arduino + PlatformIO</td></tr>
            <tr><th>Language</th><td>C++ (Arduino-flavored)</td></tr>
            <tr><th>RAM Usage</th><td>~280 KB with active conversation</td></tr>
            <tr><th>Tools</th><td>18 built-in (hardware, registry, rules, filesystem, messaging, communication)</td></tr>
            <tr><th>Rule Engine</th><td>6 conditions (incl. always/periodic), 5 action types, edge-triggered, message interpolation ({value}, {device_name}, {name:msg}), /rules.json</td></tr>
            <tr><th>Device Registry</th><td>8 sensor types (incl. 3 virtual clock), 3 actuator types, persisted to flash</td></tr>
            <tr><th>Clock Sensors</th><td>clock_hour, clock_minute, clock_hhmm - NTP-synced, POSIX timezone + DST</td></tr>
            <tr><th>Telegram Alerts</th><td>Rule-triggered, no LLM, configurable cooldown, long polling, message interpolation</td></tr>
            <tr><th>Persistent Memory</th><td>/memory.txt on flash, 512 char limit, AI-managed</td></tr>
            <tr><th>JSON Parsing</th><td>Streaming token-by-token (ArduinoJson)</td></tr>
            <tr><th>Buffer Strategy</th><td>Chunked HTTP reads, reused scratch buffers</td></tr>
            <tr><th>Flash Storage</th><td>LittleFS partition for config, history, rules, and device registry</td></tr>
            <tr><th>API Protocol</th><td>HTTPS with TLS 1.2, OpenAI-compatible chat completions, or HTTP for local LLMs (Ollama, llama.cpp)</td></tr>
            <tr><th>NATS Support</th><td>Publish, subscribe, request/reply over TCP</td></tr>
            <tr><th>NATS Sensors</th><td>nats_value type - subscribe to external NATS subjects, feed readings into rule engine, no hardware pin needed</td></tr>
            <tr><th>Local LLM</th><td>Ollama, llama.cpp, any OpenAI-compatible endpoint. HTTP mode saves ~40% RAM. No API key needed.</td></tr>
            <tr><th>Configuration</th><td>JSON config on flash - WiFi, API key, model, system prompt</td></tr>
            <tr><th>History Buffer</th><td>6-turn circular buffer persisted to flash</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Getting Started -->
  <section class="getting-started">
    <div class="container">
      <div class="section-header reveal">
        <h2>Getting <span class="accent">Started</span></h2>
        <p>Three steps from zero to a working AI agent.</p>
      </div>
      <div class="steps-list">
        <div class="step-card reveal" style="--stagger: 0">
          <div class="step-number">1</div>
          <div>
            <h3>Flash the Firmware</h3>
            <p>Clone the repo and upload with PlatformIO: <code>pio run -t upload</code></p>
          </div>
        </div>
        <div class="step-card reveal" style="--stagger: 1">
          <div class="step-number">2</div>
          <div>
            <h3>Configure on Flash</h3>
            <p>Edit <code>system_prompt.txt</code> and <code>config.json</code> with your WiFi credentials and model. Add an API key for cloud LLMs, or point to a local Ollama endpoint - no key needed. Upload with <code>pio run -t uploadfs</code></p>
          </div>
        </div>
        <div class="step-card reveal" style="--stagger: 2">
          <div class="step-number">3</div>
          <div>
            <h3>Talk to It</h3>
            <p>Send natural language via Telegram, serial console, or NATS - the agent handles the rest.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GitHub CTA -->
  <section class="github-cta">
    <div class="container">
      <h2 class="reveal">Ready to Put AI on the <span class="accent">Wire</span>?</h2>
      <div class="hero-ctas" style="justify-content: center;">
        <a href="flash.html" class="btn btn-primary reveal" style="--stagger: 1">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          Flash Now
        </a>
        <a href="architecture.html" class="btn btn-outline reveal" style="--stagger: 2">Dive Deeper &rarr;</a>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-logo">
        <img src="assets/logo.svg" width="28" height="28" alt="" aria-hidden="true">
        <span>WireClaw</span>
      </div>
      <nav class="footer-links" aria-label="Footer navigation">
        <a href="/">Home</a>
        <a href="architecture.html">Architecture</a>
        <a href="flash.html">Flash Firmware</a>
        <a href="https://github.com/M64GitHub/WireClaw" target="_blank" rel="noopener">GitHub</a>
      </nav>
      <span class="footer-copy">&copy; 2026 Mario Schallner</span>
    </div>
  </footer>

  <script defer src="js/nav.js"></script>
  <script defer src="js/scroll-reveal.js"></script>
</body>
</html>
